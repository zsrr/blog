---
title: Hibernate对象生命周期和状态
date: 2017-07-18 10:41:30
tags: [数据库,ORM,Hibernate,Java Web]
categories: ORM

---
本篇主要讲数据的管理。首先对实体实例的生命周期及状态进行讨论。
<!--more-->

# 持久化生命周期
应用程序需要在持久层考虑实体实例的生命周期，生命周期即一个实体实例所要经历的状态。
## 实体实例状态
状态及其状态的迁移如图所示：
![](http://ok34fi9ya.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-07-18%20%E4%B8%8A%E5%8D%8811.05.41.png)
下面对各个状态挨个介绍。
### 瞬时状态(Transient)
使用new操作符创造的对象实例是瞬时的，不再被引用时立即被垃圾回收。要想从瞬时状态变成持久化状态，需要调用**EntityManager#persist()**方法或者创建一个已持久化实例的引用。
### 持久化状态(Persistent)
持久化实例是具有数据库标识符的实例，此标识符为数据库表示的主键值。

通过调用**EntityManager#persist()**保存的瞬时状态实例，或者通过查询获得实例，或者通过已被持久化的实例的对象图导航从数据库检索的实例都是持久化状态的实例。
### 移除状态(Removed)
可以通过对持久化实例调用**EntityManager#remove()**方法，或者在开启孤立删除的前提下将对象实例从集合中移除，都会将持久化对象从持久化状态变为移除状态，在事务提交时，相应的数据库实例将被删除。
### 分离状态(Detached)
当加载一个实例后，关闭持久化上下文，此时应用程序仍然持有着对已经加载的实例的引用，此实例已经处于分离状态，数据已经过时。可以抛弃此引用让对象被垃圾回收，也可以调用merge()方法在新的工作单元保存修改，之后会探讨分离和合并。
## 持久化上下文
当调用**EntityManagerFactory#createEntityManager()**创建一个**EntityManager**实例时，会开启一个持久化上下文，该持久化上下文会监控管理处于持久化状态的所有实例。当一个事务提交时，持久化上下文会将内存的状态传递到数据库。

持久化上下文会充当一级缓存，它会记住处理过的所有实体实例并且保证不存在标识符相同的两个实例。当在应用程序中加载一个实例时，Hibernate 会先在缓存内查找有没有对应实例，如果有则直接返回，没有再执行查询操作。

持久化上下文会保障对象标识的可靠性。具有相同主键值的实例有且只有一个。也就是说，只要entityA.getId().equals(entityB.getId())，那么会有entityA == entityB。
